# Malware scanning

## Check website

- http://sitecheck.sucuri.net/
- http://urlfind.org/?site=

## Emergency to-do

### Block direct PHP file access

```apache
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  RewriteRule ^index\.php$ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f [OR]
  RewriteCond %{REQUEST_URI} "\.php$"
  RewriteCond %{REMOTE_ADDR} !=<MY-IP-ADDRESS>
  RewriteRule . /index.php [L]
</IfModule>
```

### Redirect all traffic to a cleaned `/index.html`

```apache
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  RewriteCond %{REQUEST_FILENAME} !-f [OR]
  RewriteCond %{REQUEST_URI} "\.php$"
  RewriteCond %{REMOTE_ADDR} !=<MY-IP-ADDRESS>
  RewriteRule . /index.html [L]
</IfModule>
```

### Prevent POST requests

```apache
<Limit POST>
    Order deny,allow
    Deny from all
    Allow from <MY-IP-ADDRESS>
    # Apache â‰¥ 2.4
    #Require ip <MY-IP-ADDRESS>
</Limit>
```

### Destroy sessions

User Session Control plugin

### Block outgoing traffic

```php
define( 'WP_HTTP_BLOCK_EXTERNAL', true );
```

### Disable file write access

```php
define( 'DISALLOW_FILE_MODS', true );
```

### Search for found malware signatures

- script src
- iframe src
- link href
- redirects

http://ddecode.com/phpdecoder/

### Search for malware patterns

```
grep -rI --include="*.php" "\$[a-zA-Z0-9_]\+(" *
grep -ri '<iframe.*src=' *
grep -ri 'eval(\|base64(' *
```

### Search DB dump

- Search for found malware signatures
- Search for malware patterns

### JAMSS

```bash
wget https://github.com/btoplak/Joomla-Anti-Malware-Scan-Script--JAMSS-/raw/master/jamss.php
patch -p0 < jamss-wordpress.patch
```

### diff WordPress core

```bash
diff -wrq . /wordpress-original-same-version/
```

Sucuri plugin

With wp-cli:

```bash
wp core verify-checksums
```

### Without FTP access: WSO web shell

https://github.com/orbweb/PHP-SHELL-WSO/downloads
remove !!! `mail()`: line 1037 `"\x6dai\154" == "mail"`



## Post infection - watch phase

### Disable file edit

```php
define( 'DISALLOW_FILE_EDIT', true );
```

### Set up PHP error logging

see: shared-hosting-aid/enable-logging.php

### POST request logging in `wp-config.php`

```php
if ( ! empty( $_POST ) ) {
    $included_files = get_included_files();
    error_log( '[warning] '
        . '[client ' . @$_SERVER['REMOTE_ADDR'] . ':' . @$_SERVER['REMOTE_PORT'] . '] '
        . 'HTTP/POST: '
        . serialize( $_POST )
        . ' <' . reset( $included_files )
        . serialize( @$_SERVER['HTTP_REFERER'] )
    );
}
```

### Audit

Simple History

### Frontpage checksum cron job

```bash
PFCHK_WEBSITE=""
PFCHK_URL=""
PFCHK_EXCLUDE_REGEX=''
PFCHK_CHKSUM=""
PFCHK_CHKSUM_GOOGLE=""
PFCHK_UA="Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:35.0) Gecko/20100101 Firefox/35.0 Waterfox/35.0"
if ! wget -qO- --max-redirect=0 --timeout=5 --user-agent="$PFCHK_UA" \
    "$PFCHK_URL" \
    | sed "s|${PFCHK_EXCLUDE_REGEX}||" \
    | md5sum | grep -q "$PFCHK_CHKSUM"; then
    echo "${PFCHK_WEBSITE}/frontpage checksum error" >&2
fi
if ! wget -qO- --max-redirect=0 --timeout=5 --referer="https://www.google.com/" --user-agent="$PFCHK_UA" \
    "$PFCHK_URL" \
    | sed "s|${PFCHK_EXCLUDE_REGEX}||" \
    | md5sum | grep -q "$PFCHK_CHKSUM_GOOGLE"; then
    echo "${PFCHK_WEBSITE}/frontpage-from-google checksum error" >&2
fi
```

### Remote log watch cron job

see: shared-hosting-aid/remote-log-watch.sh

### Tripwire from cron job

Cron job

```bash
md5sum path/to/tripwire.php|grep -q md5summd5summd5summd5summd5sum && /usr/bin/php path/to/tripwire.php
```

see: shared-hosting-aid/tripwire

Test alert!



## "Prevention package"

- File change notifications: Tripwire from cron, no plugins
- Front page change notification
- API: SafeBrowsing, Sucuri, Virustotal
- DNS checks
- domreg check/expiry
- can-send-email
