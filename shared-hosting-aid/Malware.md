# Malware scanning

## Check website

- http://sitecheck.sucuri.net/
- http://urlquery.net/
- http://urlfind.org/

## Emergency to-dos

### Block direct PHP file access

```apache
# BEGIN WordPress
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  RewriteRule ^index\.php$ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f [OR]
  RewriteCond %{REQUEST_URI} "\.php$"
  RewriteCond %{REMOTE_ADDR} !=<MY-IP-ADDRESS>
  RewriteRule . /index.php [L]
</IfModule>

# END WordPress
```

### Redirect all traffic to a cleaned `/index.html`

```apache
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  RewriteCond %{REQUEST_FILENAME} !-f [OR]
  RewriteCond %{REQUEST_URI} "\.php$"
  RewriteCond %{REMOTE_ADDR} !=<MY-IP-ADDRESS>
  RewriteRule . /index.html [L]
</IfModule>
```

### Prevent POST requests

```apache
<Limit POST>
  Order deny,allow
  Deny from all
  Allow from <MY-IP-ADDRESS>
  # Apache â‰¥ 2.4
  #Require ip <MY-IP-ADDRESS>
</Limit>
```

### Change all passwords and salts

Sucuri plugin

### Destroy sessions

User Session Control plugin

### Block outgoing traffic

```php
define( 'WP_HTTP_BLOCK_EXTERNAL', true );
```

### Disable file write access

```php
define( 'DISALLOW_FILE_MODS', true );
```

### Search for found malware signatures

- script src
- iframe src
- link href
- redirects

http://ddecode.com/phpdecoder/
http://www.unphp.net/

### Search for malware patterns

```
grep -rI --include="*.php" "\$[a-zA-Z0-9_]\+\s*(" *
grep -ri '<iframe.*src=\|<script.*src=' *
grep -ri 'eval\s*(\|base64\s*(\|<?\$\|?><?php\|preg_replace\s*(.*e' *
find -type f -mtime -30
```

### Search DB

- Search for found malware signatures
- Search for malware patterns

https://github.com/interconnectit/Search-Replace-DB/raw/master/index.php
https://github.com/interconnectit/Search-Replace-DB/raw/master/srdb.class.php

### Reinstall WordPress and plugins

Dashboard / Updates
Sucuri plugin / Post-Hack

### diff WordPress core

Sucuri plugin

```bash
diff -wrq . /wordpress-original-same-version/
```

wp-cli:

```bash
wp core verify-checksums
```

### diff theme

```bash
diff -wrq . /original-theme/
```

### Without FTP access: WSO web shell

https://github.com/orbweb/PHP-SHELL-WSO/downloads
remove !!! `mail()`: line 1037 `"\x6dai\154" == "mail"`

### JAMSS

```bash
wget https://github.com/btoplak/Joomla-Anti-Malware-Scan-Script--JAMSS-/raw/master/jamss.php
wget https://github.com/szepeviktor/wordpress-plugin-construction/raw/master/shared-hosting-aid/jamss-wordpress.patch
patch -p0 < jamss-wordpress.patch
```

### Sync back cleaned files with deletions

```bash
mirror -v -R -e --ignore-time <LOCAL-DIR> <REMOTE-DIR>
```

## Post infection - monitoring phase

### Disable file edit

```php
define( 'DISALLOW_FILE_EDIT', true );
```

### Set up PHP error logging

see: shared-hosting-aid/enable-logging.php

### POST request logging in `wp-config.php`

```php
if ( ! empty( $_POST ) ) {
    $included_files = get_included_files();
    error_log( '[warning] '
        . '[client ' . @$_SERVER['REMOTE_ADDR'] . ':' . @$_SERVER['REMOTE_PORT'] . '] '
        . 'HTTP/POST: '
        . serialize( $_POST )
        . ' <' . reset( $included_files )
        . ', referer: ' . serialize( @$_SERVER['HTTP_REFERER'] )
    );
}
```

### Audit

Sucuri / Simple History

### Frontpage checksum cron job

```bash
PFCHK_WEBSITE=""
PFCHK_URL=""
PFCHK_EXCLUDE_REGEX=''
PFCHK_CHKSUM=""
PFCHK_CHKSUM_GOOGLE=""
PFCHK_UA="Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:35.0) Gecko/20100101 Firefox/35.0 Waterfox/35.0"
if ! wget -qO- --max-redirect=0 --timeout=5 --user-agent="$PFCHK_UA" \
    "$PFCHK_URL" \
    | sed "s|${PFCHK_EXCLUDE_REGEX}||" \
    | md5sum | grep -q "$PFCHK_CHKSUM"; then
    echo "${PFCHK_WEBSITE}/frontpage checksum error" >&2
fi
if ! wget -qO- --max-redirect=0 --timeout=5 --referer="https://www.google.com/" --user-agent="$PFCHK_UA" \
    "$PFCHK_URL" \
    | sed "s|${PFCHK_EXCLUDE_REGEX}||" \
    | md5sum | grep -q "$PFCHK_CHKSUM_GOOGLE"; then
    echo "${PFCHK_WEBSITE}/frontpage-from-google checksum error" >&2
fi
```

### Remote log watch cron job

see: shared-hosting-aid/remote-log-watch.sh

### Tripwire from cron job

Cron job

```bash
md5sum path/to/tripwire.php|grep -q md5summd5summd5summd5summd5sum && /usr/bin/php path/to/tripwire.php
```

see: shared-hosting-aid/tripwire

Test alert!



## After cleanup

- Install wpf2b, Sucuri.
- Remove `.htaccess` rules.
- Request blacklist removal.
- Add caching .htaccess
- Backup files & DB & cron jobs, see: shared-hosting-aid/adminer-wp-autologin



## "Prevention package"

- wpf2b
- Sucuri plugin
- File change notifications: Tripwire from cron, no plugins
- Front page change notification
- SMTP ALLOW mail server sending notifications
- API: SafeBrowsing, Sucuri, Virustotal
- DNS checks @hourly
- Domain registration expiry @monthly
- can-send-email
- Convert WP into HTML (remote WPCF7 receiver)
