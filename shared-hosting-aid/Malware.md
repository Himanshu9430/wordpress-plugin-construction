# Malware scanning

## On-line detection tools

- http://sitecheck.sucuri.net/
- http://urlquery.net/
- http://urlfind.org/
- https://aw-snap.info/file-viewer/
- https://www.virustotal.com/#url

## In emergency

### Block PHP execution

```apache
<Files "*.php">
  Order allow,deny
  Deny from all
  Satisfy all
</Files>
```

### Block direct PHP file access

```apache
# BEGIN WordPress
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  RewriteRule ^index\.php$ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f [OR]
  RewriteCond %{REQUEST_URI} "\.php$"
  RewriteCond %{REMOTE_ADDR} !=<MY-IP-ADDRESS>
  RewriteRule . /index.php [L]
</IfModule>

# END WordPress
```

### Redirect all traffic to a cleaned `/index.html`

```apache
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  RewriteCond %{REQUEST_FILENAME} !-f [OR]
  RewriteCond %{REQUEST_URI} "\.php$"
  RewriteCond %{REMOTE_ADDR} !=<MY-IP-ADDRESS>
  RewriteRule . /index.html [L]
</IfModule>
```

### Prevent POST requests

```apache
<Limit POST>
  Order deny,allow
  Deny from all
  Allow from <MY-IP-ADDRESS>
  # Apache â‰¥ 2.4
  #Require ip <MY-IP-ADDRESS>
</Limit>
```

### Change all passwords and salts

Sucuri plugin

### Destroy sessions

User Session Control plugin

### Disable file write access

```php
define( 'DISALLOW_FILE_MODS', true );
```

### Block outgoing traffic

```php
define( 'WP_HTTP_BLOCK_EXTERNAL', true );
```

### Search for already reported malware signatures

- script src
- iframe src
- link href
- redirects
- http://ddecode.com/phpdecoder/
- http://www.unphp.net/

### Search for malware patterns

```bash
grep -r --include="*.php" "\$[a-zA-Z0-9_]\+\s*(" *
grep -r --include="*.php" "file_put_contents.*\(_SERVER\|_POST\|_REQUEST\|<?\)" *
grep -ri '<iframe.*src=\|<script.*src=' *
grep -ri '\W\(uudecode\|str_rot13\|strrev\|eval\|base64_decode\|base64_encode\|unpack\|pack\)\s*(' *
grep -ri 'WSO\|Uno_decode\|<?\$\|?><?php\|preg_replace\s*(.*e' *
find -type f -mtime -30
```

Exploit Scanner plugin

JAMSS

```bash
wget https://github.com/btoplak/Joomla-Anti-Malware-Scan-Script--JAMSS-/raw/master/jamss.php
wget https://github.com/szepeviktor/wordpress-plugin-construction/raw/master/shared-hosting-aid/jamss-wordpress.patch
patch -p0 < jamss-wordpress.patch
```

### Search DB

- Search for found malware signatures
- Search for malware patterns

https://github.com/interconnectit/Search-Replace-DB/raw/master/index.php
https://github.com/interconnectit/Search-Replace-DB/raw/master/srdb.class.php

### Reinstall WordPress and plugins

- Dashboard / Updates
- Sucuri plugin / Post-Hack

### Verify WordPress core

#### Sucuri plugin

#### Exploit Scanner plugin

#### Diff

```bash
diff -wBrq . /original-wordpress-source-same-version/
```

#### wp-cli

```bash
wp core verify-checksums
```

### Verify theme and plugins

```bash
diff -wBrq . /original-source/
```

### Working without FTP access: WSO web shell

- https://github.com/orbweb/PHP-SHELL-WSO/downloads
- remove !!! `mail()`: line 1037 `"\x6dai\154" == "mail"`

### Sync back cleaned files with deletions

```
#!/usr/bin/lftp
mirror -v -R --delete --ignore-time <LOCAL-DIR> <REMOTE-DIR>
```

## Post infection - monitoring phase

### Disable file edit

```php
define( 'DISALLOW_FILE_EDIT', true );
```

### Set up PHP error logging

See: shared-hosting-aid/enable-logging.php

### POST request logging in `wp-config.php`

```php
if ( ! empty( $_POST ) ) {
    $included_files = get_included_files();
    error_log( '[warning] '
        . '[client ' . @$_SERVER['REMOTE_ADDR'] . ':' . @$_SERVER['REMOTE_PORT'] . '] '
        . 'HTTP/POST: '
        . serialize( $_POST )
        . ' <' . reset( $included_files )
        . ', referer: ' . serialize( @$_SERVER['HTTP_REFERER'] )
    );
}
```

### Audit

- Sucuri plugin
- Simple History plugin

### Frontpage checksum cron job

```bash
PFCHK_WEBSITE_NAME=""
PFCHK_URL=""
PFCHK_EXCLUDE_PARTS_REGEX=''
PFCHK_CHKSUM=""
PFCHK_CHKSUM_GOOGLE_REFERER=""
PFCHK_UA="Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:35.0) Gecko/20100101 Firefox/35.0 Waterfox/35.0"
if ! wget -qO- --max-redirect=0 --timeout=5 --user-agent="$PFCHK_UA" \
    "$PFCHK_URL" \
    | sed "s|${PFCHK_EXCLUDE_PARTS_REGEX}||" \
    | md5sum | grep -q "$PFCHK_CHKSUM"; then
    echo "${PFCHK_WEBSITE_NAME}/frontpage checksum error" >&2
fi
if ! wget -qO- --max-redirect=0 --timeout=5 --referer="https://www.google.com/" --user-agent="$PFCHK_UA" \
    "$PFCHK_URL" \
    | sed "s|${PFCHK_EXCLUDE_PARTS_REGEX}||" \
    | md5sum | grep -q "$PFCHK_CHKSUM_GOOGLE_REFERER"; then
    echo "${PFCHK_WEBSITE_NAME}/frontpage-from-google checksum error" >&2
fi
```

### Remote log watch cron job

See: shared-hosting-aid/remote-log-watch.sh

### Tripwire from cron job

```bash
md5sum path/to/tripwire.php|grep -q md5summd5summd5summd5summd5sum && /usr/bin/php path/to/tripwire.php
```

See: shared-hosting-aid/tripwire

Test alert!



## After cleanup

- Install wpf2b, Sucuri plugin, [Ninja Firewall Pro](http://ninjafirewall.com/pro/download.php).
- Remove emergency `.htaccess` rules.
- Request blacklist removal in Google Search Console.
- Set up resource caching.
- Backup files, DB, cron jobs, see: shared-hosting-aid/adminer-wp-autologin/
- Report malware source [Google Safebrowsing Report](https://www.google.com/safebrowsing/report_badware/)
- [Stop Badware](https://www.stopbadware.org/report-badware)
- [URLquery report](http://urlquery.net/index.php)
- 



@TODO *to be moved to another document*
## "Prevention package"

- wpf2b
- Sucuri plugin
- File change notifications: Tripwire from cron, no plugins
- Front page change notification
- SMTP ALLOW mail server sending notifications
- API: SafeBrowsing, Sucuri, Virustotal
- DNS checks @hourly
- Domain registration expiry @monthly
- can-send-email @daily see: shared-hosting-aid/README.md
- Convert WP into HTML, @TODO *remote WPCF7 receiver*
